FROM registry.access.redhat.com/ubi9/nodejs-22:latest AS frontend

WORKDIR /opt/app-root/src
COPY --chown=1001:0 web/package.json web/package-lock.json ./
RUN npm ci
COPY --chown=1001:0 web/ .
RUN npm run build

FROM registry.access.redhat.com/ubi9/go-toolset:1.25 AS builder

WORKDIR /opt/app-root/src
COPY --chown=1001:0 go.mod go.sum ./
RUN go mod download
COPY --chown=1001:0 . .
COPY --from=frontend /opt/app-root/src/dist ./web/dist/
RUN CGO_ENABLED=0 go build -o /opt/app-root/release-readiness ./cmd/release-readiness/

FROM registry.access.redhat.com/ubi9-micro:latest

COPY --from=builder /opt/app-root/release-readiness /usr/local/bin/release-readiness

EXPOSE 8080
VOLUME /data

ENTRYPOINT ["release-readiness"]
CMD ["serve", "-addr", ":8080", "-db", "/data/release-readiness.db"]
